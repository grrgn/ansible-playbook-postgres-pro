# Установка и настройка PostgreSQL с помощью Ansible

## Описание

Консольное приложение, реализованное на Ansible, автоматически устанавливает PostgreSQL на наименее загруженный из двух указанных серверов (один на Debian, второй на AlmaLinux), настраивает доступ извне, создает пользователя с ограничением по IP, так же выполняет запрос с другого хоста.

## Возможности

- Подключение к удалённым серверам по SSH
- Оценка загрузки CPU на каждом сервере
- Выбор наименее загруженного хоста
- Установка PostgreSQL
- Настройка PostgreSQL для внешних соединений
- Создание пользователя `student` с разрешением подключения только с IP второго сервера
- Проверка доступности БД SQL-запросом `SELECT 1`

## Требования

- Ansible 2.15+
- Python 3.8+
- Приватный SSH-ключ с доступом к серверам под пользователем `ansible`

## Установка и запуск

1. Клонируйте репозиторий:

```bash
git clone https://github.com/grrgn/ansible-playbook-postgres-pro
cd ansible-playbook-postgres-pro
```
2. Установите роль

```bash
ansible-galaxy install -r requirements.yml
```
3. Запустите playbook с нужными ip-адресами через запятую, запятая в конце обязательна. Так же можно переопределить переменные c ключом -e.
Переменные, которые можно переопределить:
```
pg_db_user: 
pg_db_user_password: 
pg_source_addr: 
pg_listen_addresses: 
pg_database: 
pg_version:
```
Запускаем playbook.yml
```bash
ansible-playbook playbook.yml -i host1,host2,
```
## Структура проекта
- roles/postgresql/ - роль для установки и настройки PostgreSQL
- playbook.yml - основной playbook для выбора хоста для установки и выполнения запроса
- requirements.yml - зависимости playbook'а

## Принятые решения и возникшие трудности

1. Выбор инструмента
Для установки postgresql был выбран ansible как наиболее подходящее production-ready решение для автоматизации установки и конфигурирования инфраструктуры.

2. Архитектура решения
Написана роль postgresql, отвечающая за установку, настройку подключения и пользователей. Для выбора наименее загруженного хоста и выполнения запроса запускается playbook

3. Конфигурация PostgreSQL
Первоначально рассматривался вариант шаблонов Jinja2 для настройки postgresql.conf и pg_hba.conf, но был выбран модульный подход через community.postgresql.*, как более подходящий и надёжный с точки зрения безопасности и поддержки.

4. Тестирование
Использован molecule с драйвером Docker. Созданы Dockerfile для образов Debian 12 и AlmaLinux 9 с поддержкой systemd.

## Примеры
- Запускаем два хоста: Debian 12 и AlmaLinux 9
- Запускаем нагрузку на одном из хостов для проверки playbook (debian)
```bash
dd if=/dev/zero of=/dev/null bs=1M &
```
скрин

- Запускаем playbook
```bash
ansible-playbook playbook.yml -i 192.168.1.201, 192.168.1.202,
```
скрин

- Проверяем наличие PostgreSQL на хосте
```bash
команда
```
скрин
- Проверяем возможность подключения с другого хоста
```bash
команда
```
скрин
- Проверяем то же самое на другом хосте (alma)
```bash
dd if=/dev/zero of=/dev/null bs=1M &
```
скрин

- Запускаем playbook
```bash
ansible-playbook playbook.yml -i 192.168.1.201, 192.168.1.202,
```
скрин

- Проверяем наличие PostgreSQL на хосте
```bash
команда
```
скрин
- Проверяем возможность подключения с другого хоста
```bash
команда
```